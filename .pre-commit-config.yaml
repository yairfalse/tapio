# Tapio Pre-commit Hooks Configuration
# Enforces CLAUDE.md standards before commits

repos:
  # Go formatting and imports
  - repo: local
    hooks:
      - id: go-fmt
        name: Go Format
        entry: bash -c 'gofmt -l . | grep -v vendor | wc -l | xargs test 0 -eq'
        language: system
        files: '\.go$'
        pass_filenames: false
      
      - id: go-imports
        name: Go Imports
        entry: bash -c 'goimports -l . | grep -v vendor | wc -l | xargs test 0 -eq'
        language: system
        files: '\.go$'
        pass_filenames: false

  # Check for forbidden patterns
  - repo: local
    hooks:
      - id: no-todos
        name: No TODOs
        entry: bash -c '\! grep -r "TODO\|FIXME\|XXX\|HACK" --include="*.go" .'
        language: system
        pass_filenames: false
      
      - id: no-panic
        name: No panic() calls
        entry: bash -c '\! grep -r "panic(" --include="*.go" . | grep -v "init()" | grep -v "test.go"'
        language: system
        pass_filenames: false
      
      - id: no-ignored-errors
        name: No ignored errors
        entry: bash -c '\! grep -r "_ = " --include="*.go" . | grep -v "test.go"'
        language: system
        pass_filenames: false
      
      - id: no-interface-abuse
        name: No interface{} in public APIs
        entry: bash -c '\! grep -r "interface{}" --include="*.go" . | grep -v "json" | grep -v "test.go" | grep "func.*interface{}"'
        language: system
        pass_filenames: false

  # Architecture verification
  - repo: local
    hooks:
      - id: verify-architecture
        name: Verify 5-Level Architecture
        entry: ./scripts/verify-architecture.sh
        language: system
        pass_filenames: false
        files: '\.go$'

  # Build verification for changed packages
  - repo: local
    hooks:
      - id: build-check
        name: Build Check
        entry: bash -c 'go build ./...'
        language: system
        pass_filenames: false
        files: '\.go$'

  # Test verification for changed packages
  - repo: local
    hooks:
      - id: test-check
        name: Test Check
        entry: bash -c 'go test -race -timeout 30s ./...'
        language: system
        pass_filenames: false
        files: '\.go$'

  # Go vet
  - repo: local
    hooks:
      - id: go-vet
        name: Go Vet
        entry: bash -c 'go vet ./...'
        language: system
        pass_filenames: false
        files: '\.go$'

  # Security checks
  - repo: local
    hooks:
      - id: security-check
        name: Security Check
        entry: bash -c 'which gosec > /dev/null && gosec -quiet ./... || echo "gosec not installed, skipping"'
        language: system
        pass_filenames: false
        files: '\.go$'
EOF < /dev/null