#!/bin/bash
# Pre-commit hook to enforce CLAUDE.md rules

echo "üîç Running pre-commit checks..."

# Check for map[string]interface{} in staged files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$')

if [ -n "$STAGED_GO_FILES" ]; then
    echo "Checking staged Go files for violations..."
    
    for file in $STAGED_GO_FILES; do
        # Check for map[string]interface{} (exclude comments)
        if grep "map\[string\]interface{}" "$file" | grep -v "//"; then
            echo "‚ùå ERROR: $file contains map[string]interface{}"
            echo "Replace with strongly-typed structs!"
            exit 1
        fi
        
        # Check for TODOs
        if grep -q "TODO\|FIXME\|XXX\|HACK" "$file"; then
            echo "‚ùå ERROR: $file contains TODO/FIXME"
            echo "Complete the implementation before committing!"
            exit 1
        fi
        
        # Check for ignored errors
        if grep -q "_ = " "$file" | grep -v "test.go"; then
            echo "‚ùå ERROR: $file contains ignored errors"
            echo "Handle all errors properly!"
            exit 1
        fi
    done
fi

# Run gofmt check
echo "Checking formatting..."
UNFORMATTED=$(gofmt -l $STAGED_GO_FILES)
if [ -n "$UNFORMATTED" ]; then
    echo "‚ùå ERROR: Unformatted files:"
    echo "$UNFORMATTED"
    echo "Run: make fmt"
    exit 1
fi

echo "‚úÖ All pre-commit checks passed!"