//go:build linux
// +build linux

package criebpf

import (
	"fmt"

	"github.com/yairfalse/tapio/pkg/observers"
	"github.com/yairfalse/tapio/pkg/observers/orchestrator"
	"go.uber.org/zap"
)

// init registers the cri-ebpf observer factory with the observer registry
func init() {
	// Register the cri-ebpf observer factory
	RegisterCRIeBPFObserver()
}

// RegisterCRIeBPFObserver registers the cri-ebpf observer factory with the orchestrator
func RegisterCRIeBPFObserver() {
	factory := func(name string, config *orchestrator.ObserverConfigData, logger *zap.Logger) (observers.Observer, error) {
		// Convert YAML config to cri-ebpf-specific config
		criEbpfConfig := &Config{
			Name:       name,
			BufferSize: 10000, // Default
		}

		// Apply configuration from YAML
		if config != nil {
			if config.BufferSize > 0 {
				criEbpfConfig.BufferSize = config.BufferSize
			}
			criEbpfConfig.EnableOOMKill = config.EnableOOMKill
			criEbpfConfig.EnableMemoryPressure = config.EnableMemoryPressure
			criEbpfConfig.EnableProcessExit = config.EnableProcessExit
			criEbpfConfig.EnableProcessFork = config.EnableProcessFork
		}

		// Create the cri-ebpf observer (will use stub on non-Linux)
		observer, err := NewObserver(name, criEbpfConfig)
		if err != nil {
			return nil, fmt.Errorf("failed to create cri-ebpf observer %s: %w", name, err)
		}

		return observer, nil
	}

	// Register the factory with the orchestrator
	orchestrator.RegisterObserverFactory("cri-ebpf", factory)
}
