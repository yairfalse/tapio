---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: tapio-collector
  namespace: tapio-system
  labels:
    app.kubernetes.io/name: tapio-collector
    app.kubernetes.io/component: collector
    app.kubernetes.io/part-of: tapio
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: tapio-collector
      app.kubernetes.io/component: collector
  template:
    metadata:
      labels:
        app.kubernetes.io/name: tapio-collector
        app.kubernetes.io/component: collector
        app.kubernetes.io/part-of: tapio
      annotations:
        # Force restart on config changes
        checksum/config: "{{ include (print $.Template.BasePath \"/configmap.yaml\") . | sha256sum }}"
        # Security annotations
        container.apparmor.security.beta.kubernetes.io/tapio-collector: "unconfined"
        # Prometheus scraping
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: tapio-ebpf-privileged
      hostNetwork: true
      hostPID: true
      hostIPC: false
      dnsPolicy: ClusterFirstWithHostNet
      priorityClassName: tapio-high-priority
      
      # Ensure only one pod per node
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/os
                operator: In
                values: ["linux"]
              - key: kubernetes.io/arch
                operator: In
                values: ["amd64", "arm64"]
      
      # Tolerations for system nodes
      tolerations:
      - key: node-role.kubernetes.io/master
        effect: NoSchedule
      - key: node-role.kubernetes.io/control-plane
        effect: NoSchedule
      - key: CriticalAddonsOnly
        operator: Exists
      - key: node.kubernetes.io/not-ready
        effect: NoExecute
        tolerationSeconds: 30
      - key: node.kubernetes.io/unreachable
        effect: NoExecute
        tolerationSeconds: 30
      
      initContainers:
      # Kernel compatibility checker
      - name: kernel-check
        image: busybox:latest
        command: ["/bin/sh"]
        args:
        - -c
        - |
          KERNEL_VERSION=$(uname -r)
          MAJOR=$(echo $KERNEL_VERSION | cut -d. -f1)
          MINOR=$(echo $KERNEL_VERSION | cut -d. -f2)
          
          if [ "$MAJOR" -lt 4 ] || ([ "$MAJOR" -eq 4 ] && [ "$MINOR" -lt 18 ]); then
            echo "ERROR: Kernel version $KERNEL_VERSION is not supported. Minimum required: 4.18"
            exit 1
          fi
          
          echo "Kernel version $KERNEL_VERSION is supported"
          
          # Check for eBPF support
          if [ ! -d "/sys/fs/bpf" ]; then
            echo "ERROR: BPF filesystem not mounted"
            exit 1
          fi
          
          # Check for required kernel configs
          CONFIG_FILE="/boot/config-$(uname -r)"
          if [ -f "$CONFIG_FILE" ]; then
            REQUIRED_CONFIGS="CONFIG_BPF=y CONFIG_BPF_SYSCALL=y CONFIG_BPF_JIT=y CONFIG_HAVE_EBPF_JIT=y"
            for config in $REQUIRED_CONFIGS; do
              if ! grep -q "^$config" "$CONFIG_FILE"; then
                echo "WARNING: $config not found in kernel config"
              fi
            done
          fi
          
          echo "Kernel compatibility check passed"
        securityContext:
          privileged: true
        volumeMounts:
        - name: boot
          mountPath: /boot
          readOnly: true
        - name: sys
          mountPath: /sys
          readOnly: true
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi
      
      containers:
      - name: tapio-collector
        image: python:3.11-alpine
        imagePullPolicy: IfNotPresent
        
        # For testing, run a simple simulation
        command: ["/bin/sh"]
        args:
        - -c
        - |
          echo "Starting Tapio Collector Simulator"
          echo "Node: $NODE_NAME, Pod: $POD_NAME, Namespace: $POD_NAMESPACE"
          
          # Create simple health endpoint using Python
          cat > /tmp/server.py << 'EOF'
          import http.server
          import socketserver
          import threading
          import time
          
          class HealthHandler(http.server.BaseHTTPRequestHandler):
              def do_GET(self):
                  if self.path in ['/healthz', '/readyz']:
                      self.send_response(200)
                      self.send_header('Content-type', 'text/plain')
                      self.end_headers()
                      self.wfile.write(b'OK')
                  elif self.path == '/metrics':
                      self.send_response(200)
                      self.send_header('Content-type', 'text/plain')
                      self.end_headers()
                      self.wfile.write(b'# HELP test_metric Test metric\ntest_metric 1.0\n')
                  else:
                      self.send_response(404)
                      self.end_headers()
              
              def log_message(self, format, *args):
                  pass  # Suppress log messages
          
          def start_server(port):
              with socketserver.TCPServer(("", port), HealthHandler) as httpd:
                  httpd.serve_forever()
          
          # Start health server on port 8080
          threading.Thread(target=start_server, args=(8080,), daemon=True).start()
          
          # Start metrics server on port 9090  
          threading.Thread(target=start_server, args=(9090,), daemon=True).start()
          
          print("Health endpoints started on ports 8080 and 9090")
          
          # Keep running and log periodically
          while True:
              print(f"Tapio collector running on node")
              time.sleep(30)
          EOF
          
          python3 /tmp/server.py
        
        # Environment variables
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: CLUSTER_NAME
          value: "production-cluster"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://localhost:4317"
        - name: OTEL_SERVICE_NAME
          value: "tapio-collector"
        - name: OTEL_SERVICE_VERSION
          value: "1.0.0"
        - name: OTEL_RESOURCE_ATTRIBUTES
          value: "service.name=tapio-collector,service.version=1.0.0,deployment.environment=production"
        
        # Security context for eBPF
        securityContext:
          privileged: true
          runAsUser: 0
          runAsGroup: 0
          readOnlyRootFilesystem: false
          allowPrivilegeEscalation: true
          capabilities:
            add:
            - SYS_ADMIN      # Required for eBPF program loading
            - SYS_RESOURCE   # Required to remove memlock limit
            - NET_ADMIN      # Required for network operations
            - SYS_PTRACE     # Required for process tracing
            - DAC_OVERRIDE   # Required for file access
            - IPC_LOCK       # Required for memory locking
        
        # Resource limits
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi
        
        # Health checks
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 15
          periodSeconds: 10
          timeoutSeconds: 3
          successThreshold: 1
          failureThreshold: 3
        
        # Volume mounts
        volumeMounts:
        # eBPF filesystem
        - name: bpf
          mountPath: /sys/fs/bpf
        
        # System directories
        - name: sys
          mountPath: /sys
          readOnly: true
        - name: proc
          mountPath: /proc
          readOnly: true
        - name: boot
          mountPath: /boot
          readOnly: true
        - name: modules
          mountPath: /lib/modules
          readOnly: true
        - name: usr-src
          mountPath: /usr/src
          readOnly: true
        
        # Cgroup filesystem
        - name: cgroup
          mountPath: /sys/fs/cgroup
        
        # Container runtime sockets (only docker for minikube)
        - name: docker-sock
          mountPath: /var/run/docker.sock
        
        # Configuration
        - name: config
          mountPath: /etc/tapio
          readOnly: true
        
        # Temporary directory for eBPF objects
        - name: tmp
          mountPath: /tmp
        
        # Log directory
        - name: varlog
          mountPath: /var/log/tapio
      
      # OTEL Collector sidecar for node-level collection
      - name: otel-collector
        image: otel/opentelemetry-collector-contrib:0.96.0
        imagePullPolicy: IfNotPresent
        
        command: ["/otelcol-contrib"]
        args:
        - --config=/etc/otelcol-contrib/config.yaml
        
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        
        securityContext:
          runAsUser: 10001
          runAsGroup: 10001
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
        
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi
        
        ports:
        - name: otlp-grpc
          containerPort: 4317
          protocol: TCP
        - name: otlp-http
          containerPort: 4318
          protocol: TCP
        - name: metrics
          containerPort: 8888
          protocol: TCP
        
        livenessProbe:
          httpGet:
            path: /
            port: 13133
          initialDelaySeconds: 15
          periodSeconds: 20
        
        readinessProbe:
          httpGet:
            path: /
            port: 13133
          initialDelaySeconds: 5
          periodSeconds: 10
        
        volumeMounts:
        - name: otel-config
          mountPath: /etc/otelcol-contrib
          readOnly: true
        - name: otel-tmp
          mountPath: /tmp
      
      # Volumes
      volumes:
      # Host filesystem access for eBPF
      - name: bpf
        hostPath:
          path: /sys/fs/bpf
          type: DirectoryOrCreate
      
      - name: sys
        hostPath:
          path: /sys
          type: Directory
      
      - name: proc
        hostPath:
          path: /proc
          type: Directory
      
      - name: boot
        hostPath:
          path: /boot
          type: Directory
      
      - name: modules
        hostPath:
          path: /lib/modules
          type: Directory
      
      - name: usr-src
        hostPath:
          path: /usr/src
          type: DirectoryOrCreate
      
      - name: cgroup
        hostPath:
          path: /sys/fs/cgroup
          type: Directory
      
      # Container runtime sockets (only docker for minikube)
      - name: docker-sock
        hostPath:
          path: /var/run/docker.sock
          type: Socket
      
      # Configuration volumes
      - name: config
        configMap:
          name: tapio-collector-config
          defaultMode: 0644
      
      - name: otel-config
        configMap:
          name: tapio-otel-node-config
          defaultMode: 0644
      
      # Temporary volumes
      - name: tmp
        emptyDir:
          sizeLimit: 1Gi
      
      - name: otel-tmp
        emptyDir:
          sizeLimit: 512Mi
      
      # Log volume
      - name: varlog
        hostPath:
          path: /var/log/tapio
          type: DirectoryOrCreate
      
      # Termination settings
      terminationGracePeriodSeconds: 30
  
  # Update strategy
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
---
# Service for collector metrics
apiVersion: v1
kind: Service
metadata:
  name: tapio-collector-metrics
  namespace: tapio-system
  labels:
    app.kubernetes.io/name: tapio-collector
    app.kubernetes.io/component: collector
    app.kubernetes.io/part-of: tapio
spec:
  clusterIP: None  # Headless service for DaemonSet
  selector:
    app.kubernetes.io/name: tapio-collector
    app.kubernetes.io/component: collector
  ports:
  - name: metrics
    port: 9090
    targetPort: 9090
    protocol: TCP
  - name: health
    port: 8080
    targetPort: 8080
    protocol: TCP
  - name: otlp-grpc
    port: 4317
    targetPort: 4317
    protocol: TCP
  - name: otlp-http
    port: 4318
    targetPort: 4318
    protocol: TCP