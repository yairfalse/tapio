apiVersion: v1
kind: ConfigMap
metadata:
  name: tapio-cri-collector-dashboard
  namespace: monitoring
  labels:
    app: grafana
    component: dashboard
    collector: cri
    grafana_dashboard: "1"
data:
  cri-collector-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Tapio CRI Collector Metrics",
        "tags": ["tapio", "cri", "container", "kubernetes", "observability"],
        "style": "dark",
        "timezone": "browser",
        "editable": true,
        "graphTooltip": 1,
        "time": {
          "from": "now-15m",
          "to": "now"
        },
        "timepicker": {
          "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "1d"]
        },
        "refresh": "10s",
        "version": 1,
        "panels": [
          {
            "id": 1,
            "title": "CRI Events Processed Rate",
            "type": "stat",
            "targets": [
              {
                "expr": "sum(rate(cri_events_processed_total[5m])) by (collector_name, event_type)",
                "legendFormat": "{{collector_name}} - {{event_type}}",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                },
                "custom": {
                  "displayMode": "list",
                  "orientation": "horizontal"
                },
                "decimals": 2,
                "unit": "reqps",
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    },
                    {
                      "color": "yellow",
                      "value": 10
                    },
                    {
                      "color": "red",
                      "value": 100
                    }
                  ]
                }
              }
            },
            "options": {
              "reduceOptions": {
                "values": false,
                "calcs": ["lastNotNull"],
                "fields": ""
              },
              "orientation": "auto",
              "textMode": "auto",
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto"
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 0
            }
          },
          {
            "id": 2,
            "title": "OOM Kills Detected",
            "type": "stat",
            "targets": [
              {
                "expr": "sum(rate(cri_oom_kills_total[5m]))",
                "legendFormat": "OOM Kills/sec",
                "refId": "A"
              },
              {
                "expr": "sum(cri_oom_kills_total)",
                "legendFormat": "Total OOM Kills",
                "refId": "B"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "thresholds"
                },
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    },
                    {
                      "color": "yellow",
                      "value": 0.1
                    },
                    {
                      "color": "red",
                      "value": 1
                    }
                  ]
                },
                "unit": "short",
                "decimals": 3
              }
            },
            "options": {
              "reduceOptions": {
                "values": false,
                "calcs": ["lastNotNull"],
                "fields": ""
              },
              "orientation": "auto",
              "textMode": "auto",
              "colorMode": "background",
              "graphMode": "area",
              "justifyMode": "auto"
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 0
            },
            "alert": {
              "conditions": [
                {
                  "query": {
                    "queryType": "",
                    "refId": "A"
                  },
                  "reducer": {
                    "type": "avg",
                    "params": []
                  },
                  "evaluator": {
                    "params": [0.5],
                    "type": "gt"
                  }
                }
              ],
              "executionErrorState": "alerting",
              "for": "1m",
              "frequency": "10s",
              "handler": 1,
              "name": "High OOM Kill Rate",
              "noDataState": "no_data",
              "notifications": []
            }
          },
          {
            "id": 3,
            "title": "Container Processing Latency",
            "type": "timeseries",
            "targets": [
              {
                "expr": "histogram_quantile(0.50, sum(rate(cri_processing_latency_bucket[5m])) by (le, operation))",
                "legendFormat": "p50 - {{operation}}",
                "refId": "A"
              },
              {
                "expr": "histogram_quantile(0.95, sum(rate(cri_processing_latency_bucket[5m])) by (le, operation))",
                "legendFormat": "p95 - {{operation}}",
                "refId": "B"
              },
              {
                "expr": "histogram_quantile(0.99, sum(rate(cri_processing_latency_bucket[5m])) by (le, operation))",
                "legendFormat": "p99 - {{operation}}",
                "refId": "C"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                },
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "linear",
                  "barAlignment": 0,
                  "lineWidth": 1,
                  "fillOpacity": 0.1,
                  "gradientMode": "none",
                  "spanNulls": false,
                  "insertNulls": false,
                  "showPoints": "auto",
                  "pointSize": 5,
                  "stacking": {
                    "mode": "none",
                    "group": "A"
                  },
                  "axisPlacement": "auto",
                  "axisLabel": "",
                  "axisColorMode": "text",
                  "scaleDistribution": {
                    "type": "linear"
                  },
                  "axisCenteredZero": false,
                  "hideFrom": {
                    "legend": false,
                    "tooltip": false,
                    "vis": false
                  },
                  "thresholdsStyle": {
                    "mode": "off"
                  }
                },
                "unit": "ms",
                "min": 0,
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    },
                    {
                      "color": "yellow",
                      "value": 100
                    },
                    {
                      "color": "red",
                      "value": 500
                    }
                  ]
                }
              }
            },
            "options": {
              "legend": {
                "calcs": ["last", "max", "mean"],
                "displayMode": "table",
                "placement": "bottom"
              },
              "tooltip": {
                "mode": "single",
                "sort": "none"
              }
            },
            "gridPos": {
              "h": 8,
              "w": 24,
              "x": 0,
              "y": 8
            }
          },
          {
            "id": 4,
            "title": "Buffer and Resource Usage",
            "type": "timeseries",
            "targets": [
              {
                "expr": "cri_buffer_usage_percent",
                "legendFormat": "{{collector}} - Buffer Usage %",
                "refId": "A"
              },
              {
                "expr": "(process_resident_memory_bytes{job=~\".*cri.*\"} / 1024 / 1024)",
                "legendFormat": "{{instance}} - Memory Usage MB",
                "refId": "B"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                },
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "linear",
                  "barAlignment": 0,
                  "lineWidth": 1,
                  "fillOpacity": 0.1,
                  "gradientMode": "none",
                  "spanNulls": false,
                  "insertNulls": false,
                  "showPoints": "auto",
                  "pointSize": 5,
                  "stacking": {
                    "mode": "none",
                    "group": "A"
                  },
                  "axisPlacement": "auto",
                  "axisLabel": "",
                  "axisColorMode": "text",
                  "scaleDistribution": {
                    "type": "linear"
                  },
                  "axisCenteredZero": false,
                  "hideFrom": {
                    "legend": false,
                    "tooltip": false,
                    "vis": false
                  },
                  "thresholdsStyle": {
                    "mode": "line"
                  }
                },
                "min": 0,
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    },
                    {
                      "color": "yellow",
                      "value": 60
                    },
                    {
                      "color": "red",
                      "value": 80
                    }
                  ]
                }
              },
              "overrides": [
                {
                  "matcher": {
                    "id": "byName",
                    "options": "Buffer Usage %"
                  },
                  "properties": [
                    {
                      "id": "unit",
                      "value": "percent"
                    },
                    {
                      "id": "max",
                      "value": 100
                    }
                  ]
                },
                {
                  "matcher": {
                    "id": "byRegexp",
                    "options": ".*Memory.*"
                  },
                  "properties": [
                    {
                      "id": "unit",
                      "value": "decbytes"
                    }
                  ]
                }
              ]
            },
            "options": {
              "legend": {
                "calcs": ["last", "max", "mean"],
                "displayMode": "table",
                "placement": "bottom"
              },
              "tooltip": {
                "mode": "multi",
                "sort": "none"
              }
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 16
            },
            "alert": {
              "conditions": [
                {
                  "query": {
                    "queryType": "",
                    "refId": "A"
                  },
                  "reducer": {
                    "type": "last",
                    "params": []
                  },
                  "evaluator": {
                    "params": [85],
                    "type": "gt"
                  }
                }
              ],
              "executionErrorState": "alerting",
              "for": "2m",
              "frequency": "10s",
              "handler": 1,
              "name": "CRI Buffer Usage Critical",
              "noDataState": "no_data",
              "notifications": []
            }
          },
          {
            "id": 5,
            "title": "Active Containers & Events",
            "type": "timeseries",
            "targets": [
              {
                "expr": "cri_containers_active",
                "legendFormat": "{{collector}} - Active Containers",
                "refId": "A"
              },
              {
                "expr": "rate(cri_events_dropped_total[5m]) * 60",
                "legendFormat": "{{collector}} - Events Dropped/min",
                "refId": "B"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                },
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "linear",
                  "barAlignment": 0,
                  "lineWidth": 1,
                  "fillOpacity": 0.1,
                  "gradientMode": "none",
                  "spanNulls": false,
                  "insertNulls": false,
                  "showPoints": "auto",
                  "pointSize": 5,
                  "stacking": {
                    "mode": "none",
                    "group": "A"
                  },
                  "axisPlacement": "auto",
                  "axisLabel": "",
                  "axisColorMode": "text",
                  "scaleDistribution": {
                    "type": "linear"
                  },
                  "axisCenteredZero": false,
                  "hideFrom": {
                    "legend": false,
                    "tooltip": false,
                    "vis": false
                  },
                  "thresholdsStyle": {
                    "mode": "off"
                  }
                },
                "unit": "short",
                "min": 0
              },
              "overrides": [
                {
                  "matcher": {
                    "id": "byRegexp",
                    "options": ".*Dropped.*"
                  },
                  "properties": [
                    {
                      "id": "color",
                      "value": {
                        "mode": "fixed",
                        "fixedColor": "red"
                      }
                    }
                  ]
                }
              ]
            },
            "options": {
              "legend": {
                "calcs": ["last", "max"],
                "displayMode": "table",
                "placement": "bottom"
              },
              "tooltip": {
                "mode": "multi",
                "sort": "none"
              }
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 16
            }
          },
          {
            "id": 6,
            "title": "CRI and eBPF Errors",
            "type": "timeseries",
            "targets": [
              {
                "expr": "sum(rate(cri_errors_total[5m])) by (operation, error)",
                "legendFormat": "CRI: {{operation}} - {{error}}",
                "refId": "A"
              },
              {
                "expr": "sum(rate(cri_ebpf_load_errors_total[5m])) by (error_type)",
                "legendFormat": "eBPF Load: {{error_type}}",
                "refId": "B"
              },
              {
                "expr": "sum(rate(cri_ebpf_attach_errors_total[5m])) by (program, error_type)",
                "legendFormat": "eBPF Attach: {{program}} - {{error_type}}",
                "refId": "C"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                },
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "linear",
                  "barAlignment": 0,
                  "lineWidth": 1,
                  "fillOpacity": 0.1,
                  "gradientMode": "none",
                  "spanNulls": false,
                  "insertNulls": false,
                  "showPoints": "auto",
                  "pointSize": 5,
                  "stacking": {
                    "mode": "none",
                    "group": "A"
                  },
                  "axisPlacement": "auto",
                  "axisLabel": "",
                  "axisColorMode": "text",
                  "scaleDistribution": {
                    "type": "linear"
                  },
                  "axisCenteredZero": false,
                  "hideFrom": {
                    "legend": false,
                    "tooltip": false,
                    "vis": false
                  },
                  "thresholdsStyle": {
                    "mode": "off"
                  }
                },
                "unit": "reqps",
                "min": 0
              }
            },
            "options": {
              "legend": {
                "calcs": ["last", "max"],
                "displayMode": "table",
                "placement": "bottom"
              },
              "tooltip": {
                "mode": "multi",
                "sort": "none"
              }
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 24
            }
          },
          {
            "id": 7,
            "title": "eBPF Events & Kernel OOM Kills",
            "type": "timeseries",
            "targets": [
              {
                "expr": "sum(rate(cri_ebpf_events_total[5m]))",
                "legendFormat": "eBPF Events/sec",
                "refId": "A"
              },
              {
                "expr": "sum(rate(cri_ebpf_events_dropped_total[5m]))",
                "legendFormat": "eBPF Events Dropped/sec",
                "refId": "B"
              },
              {
                "expr": "sum(rate(cri_ebpf_kernel_oom_kills_total[5m]))",
                "legendFormat": "Kernel OOM Kills/sec",
                "refId": "C"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                },
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "linear",
                  "barAlignment": 0,
                  "lineWidth": 1,
                  "fillOpacity": 0.1,
                  "gradientMode": "none",
                  "spanNulls": false,
                  "insertNulls": false,
                  "showPoints": "auto",
                  "pointSize": 5,
                  "stacking": {
                    "mode": "none",
                    "group": "A"
                  },
                  "axisPlacement": "auto",
                  "axisLabel": "",
                  "axisColorMode": "text",
                  "scaleDistribution": {
                    "type": "linear"
                  },
                  "axisCenteredZero": false,
                  "hideFrom": {
                    "legend": false,
                    "tooltip": false,
                    "vis": false
                  },
                  "thresholdsStyle": {
                    "mode": "off"
                  }
                },
                "unit": "reqps",
                "min": 0
              },
              "overrides": [
                {
                  "matcher": {
                    "id": "byRegexp",
                    "options": ".*Dropped.*"
                  },
                  "properties": [
                    {
                      "id": "color",
                      "value": {
                        "mode": "fixed",
                        "fixedColor": "red"
                      }
                    }
                  ]
                },
                {
                  "matcher": {
                    "id": "byRegexp",
                    "options": ".*OOM.*"
                  },
                  "properties": [
                    {
                      "id": "color",
                      "value": {
                        "mode": "fixed",
                        "fixedColor": "orange"
                      }
                    }
                  ]
                }
              ]
            },
            "options": {
              "legend": {
                "calcs": ["last", "max"],
                "displayMode": "table",
                "placement": "bottom"
              },
              "tooltip": {
                "mode": "multi",
                "sort": "none"
              }
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 24
            }
          },
          {
            "id": 8,
            "title": "Container Events by Type",
            "type": "piechart",
            "targets": [
              {
                "expr": "sum by (event_type) (increase(cri_events_processed_total[15m]))",
                "legendFormat": "{{event_type}}",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                },
                "custom": {
                  "hideFrom": {
                    "legend": false,
                    "tooltip": false,
                    "vis": false
                  }
                },
                "unit": "short"
              }
            },
            "options": {
              "reduceOptions": {
                "values": false,
                "calcs": ["lastNotNull"],
                "fields": ""
              },
              "pieType": "pie",
              "tooltip": {
                "mode": "single",
                "sort": "none"
              },
              "legend": {
                "displayMode": "list",
                "placement": "right"
              },
              "displayLabels": ["name", "value", "percent"]
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 32
            }
          },
          {
            "id": 9,
            "title": "State Check Performance",
            "type": "timeseries",
            "targets": [
              {
                "expr": "rate(cri_checks_performed_total[5m])",
                "legendFormat": "State Checks/sec",
                "refId": "A"
              },
              {
                "expr": "histogram_quantile(0.95, rate(cri_batch_size_bucket[5m]))",
                "legendFormat": "p95 Batch Size",
                "refId": "B"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                },
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "linear",
                  "barAlignment": 0,
                  "lineWidth": 1,
                  "fillOpacity": 0.1,
                  "gradientMode": "none",
                  "spanNulls": false,
                  "insertNulls": false,
                  "showPoints": "auto",
                  "pointSize": 5,
                  "stacking": {
                    "mode": "none",
                    "group": "A"
                  },
                  "axisPlacement": "auto",
                  "axisLabel": "",
                  "axisColorMode": "text",
                  "scaleDistribution": {
                    "type": "linear"
                  },
                  "axisCenteredZero": false,
                  "hideFrom": {
                    "legend": false,
                    "tooltip": false,
                    "vis": false
                  },
                  "thresholdsStyle": {
                    "mode": "off"
                  }
                },
                "min": 0
              },
              "overrides": [
                {
                  "matcher": {
                    "id": "byRegexp",
                    "options": ".*Checks.*"
                  },
                  "properties": [
                    {
                      "id": "unit",
                      "value": "reqps"
                    }
                  ]
                },
                {
                  "matcher": {
                    "id": "byRegexp",
                    "options": ".*Batch.*"
                  },
                  "properties": [
                    {
                      "id": "unit",
                      "value": "short"
                    }
                  ]
                }
              ]
            },
            "options": {
              "legend": {
                "calcs": ["last", "mean"],
                "displayMode": "table",
                "placement": "bottom"
              },
              "tooltip": {
                "mode": "multi",
                "sort": "none"
              }
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 32
            }
          }
        ],
        "templating": {
          "list": [
            {
              "current": {
                "selected": false,
                "text": "All",
                "value": "$__all"
              },
              "hide": 0,
              "includeAll": true,
              "label": "Collector",
              "multi": true,
              "name": "collector",
              "options": [],
              "query": "label_values(cri_events_processed_total, collector)",
              "refresh": 1,
              "regex": "",
              "skipUrlSync": false,
              "sort": 0,
              "tagValuesQuery": "",
              "tagsQuery": "",
              "type": "query",
              "useTags": false,
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              }
            },
            {
              "current": {
                "selected": false,
                "text": "All",
                "value": "$__all"
              },
              "hide": 0,
              "includeAll": true,
              "label": "Namespace",
              "multi": true,
              "name": "namespace",
              "options": [],
              "query": "label_values(cri_events_processed_total{collector=~\"$collector\"}, namespace)",
              "refresh": 1,
              "regex": "",
              "skipUrlSync": false,
              "sort": 0,
              "tagValuesQuery": "",
              "tagsQuery": "",
              "type": "query",
              "useTags": false,
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              }
            }
          ]
        },
        "annotations": {
          "list": [
            {
              "builtIn": 1,
              "datasource": {
                "type": "grafana",
                "uid": "-- Grafana --"
              },
              "enable": true,
              "hide": true,
              "iconColor": "rgba(0, 211, 255, 1)",
              "name": "Annotations & Alerts",
              "type": "dashboard"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "enable": true,
              "expr": "ALERTS{alertname=~\".*CRI.*|.*Container.*\"}",
              "hide": false,
              "iconColor": "red",
              "name": "CRI Alerts",
              "showIn": 0,
              "step": "60s",
              "tagKeys": "alertname,instance",
              "titleFormat": "{{alertname}}",
              "type": "prometheus",
              "useValueForTime": false
            }
          ]
        },
        "links": [
          {
            "asDropdown": false,
            "icon": "external link",
            "includeVars": false,
            "keepTime": false,
            "tags": [],
            "targetBlank": true,
            "title": "Tapio Documentation",
            "tooltip": "",
            "type": "link",
            "url": "https://github.com/yairfalse/tapio"
          }
        ]
      }
    }